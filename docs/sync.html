<!DOCTYPE html>  <html> <head>   <title>sync.coffee</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               sync.coffee             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <h3>Backbone.HookSync</h3>

<p>This file provides a function, <code>make</code> for building a new
sync function for your Backbone.Model which will call the methods
you define.  It is particularily useful for integrating Backbone
with the JavaScript API interface of your choice.</p>

<p>The basic idea:</p>

<pre><code>class MyAwesomeModel extends Backbone.Model
  sync: Backbone.HookSync.make
    create: myAwesomeCreator
    update: 'create'
    delete: 'default'
    read: 
      do: myAwesomeReader
      build: (method, model, options) -&gt;
        model.attributes
</code></pre>

<p>The file also provides two functions to add a new sync method to
your existing classes.</p>

<p><code>bind</code> adds the method to an existing class:</p>

<pre><code>class MyAwesomeModel extends Backbone.Model
  # Model Dets Here

Backbone.HookSync.bind MyAwesomeModel,
  create: newCreator

  # Reads, Updates and Deletes will continue to use the
  # models sync, or if one is not defined, Backbone.Sync
</code></pre>

<p><code>wrap</code> returns a new copy of your class with the sync method replaced:</p>

<pre><code>class MyAwesomeModel extends Backbone.Model
  # Some Modeling..

MoreAwesomeModel = Backbone.HookSync.wrap MyAwesomeModel,
  update: _.noop
</code></pre>

<h4>Options</h4>

<p>All three methods expect an object containing 1-4 of the CRUD methods:</p>

<ul>
<li>create</li>
<li>read</li>
<li>update</li>
<li>delete</li>
</ul>

<p>And, optionally, a <code>sync</code> method which will be used with requests which
do not match one of the provided methods (or for methods defined as
'default').</p>

<p>Each of the CRUD method keys can have any of the following values:</p>

<ul>
<li>A function (to do the action)</li>
<li>A string referring to another CRUD method who's value should be used</li>
<li>'default', <code>null</code>, or <code>undefined</code> representing the default sync behavior</li>
<li>An object</li>
</ul>

<p>If an object is used it can have the following attributes:</p>

<ul>
<li><code>function do</code> - The function to be called (make sure you use string notation ["do"] if
you're not writing CoffeeScript)</li>
<li><code>function build(method, model, options)</code> - A function used to build the request passed
into do.</li>
<li><code>boolean expandArguments[false]</code> - Should the array returned by <code>build</code> be
expanded and passed into do as seperate arguments?</li>
<li><code>boolean returnsPromise[false]</code> - Does do return a Deferred object?  If so
it's done and fail methods will trigger the success and error
callbacks (and the default callbacks will be disabled).</li>
<li><code>boolean noOptions[false]</code> - Should the options hash not be merged in with
the return value of build?</li>
</ul>

<p>If you're using expandArguments, noOptions is implied.</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <p>Returns a copy of the class with sync extended by the handlers.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">wrap = </span><span class="nf">(cls, handlers) -&gt;</span>
    <span class="nv">nCls = </span><span class="nx">cls</span>
    <span class="nv">nCls:: = </span><span class="nx">_</span><span class="p">.</span><span class="nx">clone</span> <span class="nv">cls::</span>

    <span class="nx">bind</span> <span class="nx">nCls</span><span class="p">,</span> <span class="nx">handlers</span>

    <span class="nx">nCls</span></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>Mutates an existing class to replace sync with a new sync
method powered by the handlers.</p>

<p>Preserves a reference to the existing sync, so any method
not handled will fall through to the original.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">bind = </span><span class="nf">(cls, handlers) -&gt;</span>
    <span class="k">if</span> <span class="nx">cls</span><span class="o">::</span><span class="nx">sync</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>make knows to look at handlers.sync if the sync method
is not bound in the handlers (or is bound as 'default').</p>

<p>If there is no cls::sync (the default case for Backbone), 
make will use Backbone.sync.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">handlers</span><span class="p">.</span><span class="nx">sync</span> <span class="o">?=</span> <span class="nx">cls</span><span class="o">::</span><span class="nx">sync</span>

    <span class="nv">cls::sync = </span><span class="nx">make</span> <span class="nx">handlers</span>
    
    <span class="nx">cls</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>Build a sync function compatable with Backbone out of one or more
CRUD functions.  Anything you don't override will get passed through
to the default sync function.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">make = </span><span class="nf">(handlers) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>Handlers is a map of CRUD methods to the functions which should
handle them + some other options.</p>

<p>Normalize the handler to always be an object with a 
make method.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">handlersToObjects</span> <span class="nx">handlers</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>Replace all of the string handler pointers with
the actual handlers they point to.  Replace 'default'
with null</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">resolveHandlers</span> <span class="nx">handlers</span></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>This is the sync-replacement we'll be returning</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nf">(method, model, options) -&gt;</span>
      <span class="nv">handler = </span><span class="nx">handlers</span><span class="p">[</span><span class="nx">method</span><span class="p">]</span>

      <span class="k">if</span> <span class="nx">handler</span>
        <span class="nv">request = </span><span class="nx">buildRequest</span> <span class="nx">handler</span><span class="p">,</span> <span class="nx">method</span><span class="p">,</span> <span class="nx">model</span><span class="p">,</span> <span class="nx">options</span>

        <span class="nx">makeRequest</span> <span class="nx">handler</span><span class="p">,</span> <span class="nx">request</span><span class="p">,</span> <span class="nx">options</span>

      <span class="k">else</span></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>This method is most likely gonna be overriding the
model's sync method, so calling @sync would recurse, so
we let the fall-through sync be passed in as an option.</p>

<p><code>wrap</code> and <code>bind</code> do this for you, automatically preserving the
previous sync in handlers.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="p">(</span><span class="nx">handlers</span><span class="p">.</span><span class="nx">sync</span> <span class="o">or</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">sync</span><span class="p">)</span> <span class="nx">method</span><span class="p">,</span> <span class="nx">model</span><span class="p">,</span> <span class="nx">options</span></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p>In this context, a request is the object which will be passed
into the <code>do</code> function passed in as a handler.  Based on the
<code>expandArguments</code> property, it can either be a single object,
or an array of arguments.</p>

<p>Unless you set handler.noOptions, the options object will be
automatically merged with the attributes your return.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">buildRequest = </span><span class="nf">(handler, method, model, options) -&gt;</span>
    <span class="k">if</span> <span class="nx">handler</span><span class="p">.</span><span class="nx">build</span><span class="o">?</span>
      <span class="nv">req = </span><span class="nx">handler</span><span class="p">.</span><span class="nx">build</span> <span class="nx">method</span><span class="p">,</span> <span class="nx">model</span><span class="p">,</span> <span class="nx">options</span>

      <span class="k">unless</span> <span class="nx">handler</span><span class="p">.</span><span class="nx">noOptions</span> <span class="o">or</span> <span class="nx">handler</span><span class="p">.</span><span class="nx">expandArguments</span>
        <span class="nv">req = </span><span class="nx">_</span><span class="p">.</span><span class="nx">extend</span> <span class="p">{},</span> <span class="nx">options</span><span class="p">,</span> <span class="nx">req</span>

      <span class="nx">req</span>
    <span class="k">else</span>
      <span class="nx">options</span>
      </pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <p>Do it!</p>

<p>handler.returnsPromise gives you a convenient way to
convert a method which normally returns a promise to
work with Backbone's success and error handlers.</p>

<p>It will replace the passed-in success and error handlers
with noops so they are not called twice.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">makeRequest = </span><span class="nf">(handler, request, options) -&gt;</span>
    <span class="k">if</span> <span class="nx">handler</span><span class="p">.</span><span class="nx">returnsPromise</span>
      <span class="nv">oldOptions = </span><span class="nx">_</span><span class="p">.</span><span class="nx">pick</span> <span class="nx">options</span><span class="p">,</span> <span class="s">&#39;success&#39;</span><span class="p">,</span> <span class="s">&#39;error&#39;</span>
      <span class="nv">options.success = options.error = </span><span class="nf">-&gt;</span>

    <span class="k">if</span> <span class="nx">handler</span><span class="p">.</span><span class="nx">expandArguments</span>
      <span class="nv">resp = </span><span class="nx">handler</span><span class="p">.</span><span class="nx">do</span> <span class="nx">request</span><span class="p">...</span>
    <span class="k">else</span>
      <span class="nv">resp = </span><span class="nx">handler</span><span class="p">.</span><span class="nx">do</span> <span class="nx">request</span>
     
    <span class="k">if</span> <span class="nx">handler</span><span class="p">.</span><span class="nx">returnsPromise</span>
      <span class="nx">resp</span><span class="p">.</span><span class="nx">done</span> <span class="nf">(data) -&gt;</span>
        <span class="nx">oldOptions</span><span class="p">.</span><span class="nx">success</span> <span class="nx">data</span>

      <span class="nx">resp</span><span class="p">.</span><span class="nx">fail</span> <span class="nf">(err) -&gt;</span>
        <span class="nx">oldOptions</span><span class="p">.</span><span class="nx">error</span> <span class="nx">err</span></pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <p>Handler can be passed in as either functions, or
objects which have some more options and functions.
To make it easier, lets make them objects all of the time.</p>

<p>It modifies the passed in object in-place.</p>

<p>The conical shape of this function is critical to its
success.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">handlersToObjects = </span><span class="nf">(handlers) -&gt;</span>
    <span class="k">for</span> <span class="nx">type</span><span class="p">,</span> <span class="nx">handler</span> <span class="k">of</span> <span class="nx">handlers</span>
      <span class="k">if</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isFunction</span> <span class="nx">handler</span>
        <span class="nx">handlers</span><span class="p">[</span><span class="nx">handler</span><span class="p">]</span> <span class="o">=</span>
          <span class="nv">do: </span><span class="nx">handler</span></pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <p>Handlers can be string references to the keys of other handlers,
or 'default'.</p>

<p>Modifies the passed in object in-place.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">resolveHandlers = </span><span class="nf">(handlers) -&gt;</span>
    <span class="k">for</span> <span class="nx">type</span><span class="p">,</span> <span class="nx">handler</span> <span class="k">of</span> <span class="nx">handlers</span>
      <span class="k">switch</span> <span class="nx">handler</span>
        <span class="k">when</span> <span class="s">&#39;default&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <p>In this context, <code>default</code> means pass request through to
<code>handlers.sync</code> or <code>Backbone.sync</code>.</p>

<p>For convenience, normalize default to be falsy
as we also support simply skipping the handler type to
signify 'default'</p>             </td>             <td class="code">               <div class="highlight"><pre>          <span class="nx">handlers</span><span class="p">[</span><span class="nx">type</span><span class="p">]</span> <span class="o">=</span> <span class="kc">null</span>
        <span class="k">when</span> <span class="s">&#39;create&#39;</span><span class="p">,</span> <span class="s">&#39;read&#39;</span><span class="p">,</span> <span class="s">&#39;update&#39;</span><span class="p">,</span> <span class="s">&#39;delete&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <p>You can alias the handler to another handler.</p>

<p>The most common usage of this is to map create to the same thing
as update, e.g.:</p>

<pre><code>make
  create: myHandler
  update: 'create'
</code></pre>

<p>This is only going to reliably work to one level of depth,
you can't reference references.</p>             </td>             <td class="code">               <div class="highlight"><pre>          <span class="nx">handlers</span><span class="p">[</span><span class="nx">type</span><span class="p">]</span> <span class="o">=</span> <span class="nx">handlers</span><span class="p">[</span><span class="nx">handler</span><span class="p">]</span>

  <span class="nv">exports = </span><span class="p">{</span><span class="nx">make</span><span class="p">,</span> <span class="nx">wrap</span><span class="p">,</span> <span class="nx">bind</span><span class="p">}</span>
  <span class="nx">Backbone</span><span class="o">?</span><span class="p">.</span><span class="nv">HookSync = </span><span class="nx">exports</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 